<% if (theme.comments.minivaline.js) { %>
  <%- js(theme.comments.minivaline.js) %>
<% } else { %>
  <script src="https://cdn.jsdelivr.net/npm/minivaline@3/dist/MiniValine.min.js"></script>
<% } %>
<% var emoticonUrl = theme.comments.minivaline.emoticonUrl || [] %>
<% var tagMeta = theme.comments.minivaline.tagMeta || [] %>
<% var master = theme.comments.minivaline.master || [] %>
<% var friends = theme.comments.minivaline.friends  || []  %>
<script>
function pjax_minivaline() {
  let pageUrl = $.trim($('#pjax-comment-path').text()) === "none" ? 
      decodeURI(window.location.pathname) : $.trim($('#pjax-comment-path').text());
  let pagePlaceholder = $.trim($('#pjax-comment-placeholder').text()) === "none" ?
    "<%= theme.comments.placeholder %>" : $.trim($('#pjax-comment-placeholder').text());

  let ALLPATH = '<%= theme.comments.path %>';
  if(ALLPATH != '') pageUrl = ALLPATH;

  new MiniValine({
    el: '#minivaline_container',
    appId: '<%= theme.comments.minivaline.appId %>',
    appKey: '<%= theme.comments.minivaline.appKey %>',
    mode: '<%= theme.comments.minivaline.mode %>',
    placeholder: pagePlaceholder,
    path: pageUrl,
    lang: '<%= theme.comments.minivaline.lang %>',
    adminEmailMd5: '<%= theme.comments.minivaline.adminEmailMd5 %>',
    tagMeta: <%- '["' + tagMeta.join('", "') + '"]' %>,
    master: <%- '["' + master.join('", "') + '"]' %>,
    friends: <%- '["' + friends.join('", "') + '"]' %>,
    math: <%= theme.comments.minivaline.math %>,  /*布尔值 字符串无效 下同*/
    md: <%= theme.comments.minivaline.md %>,
    enableQQ: <%= theme.comments.minivaline.enableQQ %>,
    NoRecordIP: <%= theme.comments.minivaline.NoRecordIP %>,
    visitor: <%= theme.comments.minivaline.visitor %>,
    maxNest: <%= theme.comments.minivaline.maxNest %>,
    pageSize: <%= theme.comments.minivaline.pageSize %>,
    barrager: <%= theme.comments.minivaline.barrager %>,
    role: '<%= theme.comments.minivaline.role %>',
    closeFlag: <%= theme.comments.minivaline.closeFlag %>,
    cloudflag: <%= theme.comments.minivaline.cloudflag %>,
    region: <%= theme.comments.minivaline.region %>,
    closeUA: <%= theme.comments.minivaline.closeUA %>,
    emoticonUrl: <%- '["' + emoticonUrl.join('", "') + '"]' %>,
    serverURLs: '<%= theme.comments.minivaline.serverURLs %>'
    });
  }
  $(function () {
    pjax_minivaline();
  });
</script>
